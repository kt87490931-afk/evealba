# 이브알바 인프라 설정 플랜

> **그누보드5 + GitHub + SQL Migration** 기반 개발·배포 환경 구축  
> 작성일: 2025-02-23  
> 대상 서버: evealba (188.166.179.115, Ubuntu 24.04)

---

## 목차

1. [전체 흐름 개요](#1-전체-흐름-개요)
2. [Phase 1: 서버 세팅](#2-phase-1-서버-세팅)
3. [Phase 2: GitHub 세팅](#3-phase-2-github-세팅)
4. [Phase 3: SQL Migration 세팅](#4-phase-3-sql-migration-세팅)
5. [Phase 4: Cursor AI ↔ 서버 연결](#5-phase-4-cursor-ai--서버-연결)
6. [Phase 5: Cursor AI ↔ GitHub 연결](#6-phase-5-cursor-ai--github-연결)
7. [Phase 6: SQL Migration ↔ Cursor AI 연결](#7-phase-6-sql-migration--cursor-ai-연결)
8. [동일 실수 방지용 해결책](#8-동일-실수-방지용-해결책)
9. [검증 체크리스트](#9-검증-체크리스트)

---

## 1. 전체 흐름 개요

```
[로컬 PC]  ←── Cursor AI ──→  [GitHub]
    │                              │
    │   SSH (키 인증)               │   git push/pull
    ▼                              ▼
[서버 evealba]  ←── git pull ──  [evealba 저장소]
    │
    ├── /var/www/evealba (그누보드5)
    ├── MySQL
    ├── Nginx + PHP-FPM
    └── run_migration.php (SQL Migration 실행)
```

**작업 순서**: Phase 1 → 2 → 3 → 4 → 5 → 6

---

## 2. Phase 1: 서버 세팅

### 2.1 목표

- 그누보드5 실행 환경 (PHP, MySQL, Nginx/Apache)
- ScorePoint와 동일한 구조 준비

### 2.2 사전 확인

| 항목 | 확인 방법 |
|------|-----------|
| SSH 접속 | `ssh root@188.166.179.115` |
| OS | Ubuntu 24.04 LTS |

### 2.3 단계별 액션

#### 2.3.1 PHP 설치

```bash
# Ubuntu 24.04: PHP 8.3 (8.2 없음)
apt update
apt install -y php8.3-fpm php8.3-mysql php8.3-mbstring php8.3-xml php8.3-curl php8.3-gd php8.3-zip php8.3-intl
```

**검증**: `php -v` → `PHP 8.3.x` 출력

#### 2.3.2 MySQL 설치

```bash
apt install -y mysql-server
mysql_secure_installation
```

- root 비밀번호 설정
- 익명 사용자 제거, 원격 root 로그인 비활성화 (선택)

**검증**: `mysql -u root -p -e "SELECT 1"`

#### 2.3.3 이브알바용 DB·사용자 생성

```bash
mysql -u root -p -e "
CREATE DATABASE evealba_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'evealba'@'localhost' IDENTIFIED BY '안전한비밀번호';
GRANT ALL PRIVILEGES ON evealba_db.* TO 'evealba'@'localhost';
FLUSH PRIVILEGES;
"
```

> ⚠️ `안전한비밀번호`는 실제 비밀번호로 교체. `.env` 또는 `config.php`에 기록.

#### 2.3.4 Nginx 설치 및 사이트 설정

```bash
apt install -y nginx
```

`/etc/nginx/sites-available/evealba` 생성:

```nginx
server {
    listen 80;
    server_name 188.166.179.115;   # 도메인 적용 시 변경
    root /var/www/evealba;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /bbs/index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\. {
        deny all;
    }
}
```

```bash
ln -s /etc/nginx/sites-available/evealba /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

#### 2.3.5 웹 루트 및 권한

```bash
mkdir -p /var/www/evealba
chown -R www-data:www-data /var/www/evealba
chmod 755 /var/www/evealba
```

#### 2.3.6 Git 설치

```bash
apt install -y git
git config --global user.email "your@email.com"
git config --global user.name "evealba"
```

### 2.4 산출물

- PHP 8.2 + FPM
- MySQL + evealba_db
- Nginx + evealba 사이트
- /var/www/evealba 디렉토리

---

## 3. Phase 2: GitHub 세팅

### 3.1 목표

- evealba 프로젝트 GitHub 저장소 생성
- 로컬 프로젝트와 원격 저장소 연결

### 3.2 단계별 액션

#### 3.2.1 GitHub 저장소 생성

1. [GitHub](https://github.com) 로그인
2. **New repository** 클릭
3. 저장소명: `evealba` (또는 원하는 이름)
4. **Private** 권장 (민감 정보 포함 시)
5. **Create repository** (README, .gitignore는 생성하지 않음)

#### 3.2.2 로컬 프로젝트 초기화

**로컬 PC (d:\evealba)에서:**

```powershell
cd d:\evealba

# Git 초기화
git init

# 기본 브랜치명 설정
git branch -M main

# 원격 저장소 연결 (본인 GitHub URL로 교체)
git remote add origin https://github.com/본인아이디/evealba.git
```

#### 3.2.3 .gitignore 생성

`d:\evealba\.gitignore` 생성:

```gitignore
# 환경설정 (비밀번호 포함)
.env
*.env.local
config.php
common.php

# 데이터/캐시
data/
extend/
theme/scorepoint/data/
*.log

# OS
.DS_Store
Thumbs.db

# IDE
.idea/
.vscode/
*.swp
```

> `common.php`는 그누보드 설치 후 생성되므로, `common.php.sample`만 저장하고 실제 `common.php`는 제외.

#### 3.2.4 최초 커밋 및 푸시

```powershell
git add .
git status   # 확인
git commit -m "Initial: 이브알바 프로젝트 구조"
git push -u origin main
```

**인증**: GitHub Personal Access Token 또는 SSH 키 사용 권장.

### 3.5 산출물

- GitHub `evealba` 저장소
- 로컬 `origin` 원격 연결
- .gitignore 적용

---

## 4. Phase 3: SQL Migration 세팅

### 4.1 목표

- 마이그레이션 파일 구조 정의
- `run_migration.php` 실행 스크립트 작성
- DB에 실행 이력(schema_migrations) 저장

### 4.2 디렉토리 구조

```
evealba/
├── migrations/
│   ├── 001_install_gnuboard_base.sql    # 그누보드 기본 (필요 시)
│   ├── 002_create_ev_master_tables.sql  # 마스터 테이블
│   ├── 003_create_ev_member_profile.sql
│   └── README.md
├── run_migration.php
└── ...
```

### 4.3 단계별 액션

#### 4.3.1 migrations 디렉토리 생성

```powershell
mkdir d:\evealba\migrations
```

#### 4.3.2 schema_migrations 테이블용 초기 마이그레이션

`migrations/000_schema_migrations.sql` 생성:

```sql
-- 이브알바 SQL Migration: 실행 이력 테이블
CREATE TABLE IF NOT EXISTS `g5_schema_migrations` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `migration` VARCHAR(255) NOT NULL,
  `executed_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `migration` (`migration`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.3.3 run_migration.php 작성

`d:\evealba\run_migration.php` 생성:

```php
<?php
/**
 * 이브알바 SQL Migration 실행 스크립트
 * 사용법: php run_migration.php [--dry-run]
 */

define('G5_PATH', __DIR__);
require_once G5_PATH . '/common.php';  // 그누보드 설치 후 활성화

$dryRun = in_array('--dry-run', $argv ?? []);

$migrationsDir = G5_PATH . '/migrations';
if (!is_dir($migrationsDir)) {
    die("migrations 디렉토리가 없습니다.\n");
}

$files = glob($migrationsDir . '/*.sql');
usort($files, function ($a, $b) {
    return strcmp(basename($a), basename($b));  // 001, 002, 003 순서
});

$run = [];
foreach ($files as $f) {
    $name = basename($f, '.sql');
    if ($name === 'README') continue;

    $sql = file_get_contents($f);
    if (trim($sql) === '') continue;

    if ($dryRun) {
        echo "[DRY-RUN] would run: $name\n";
        continue;
    }

    $exists = sql_fetch("SELECT 1 FROM g5_schema_migrations WHERE migration = '" . sql_real_escape_string($name) . "'");
    if ($exists) {
        echo "[SKIP] $name (already executed)\n";
        continue;
    }

    $queries = array_filter(array_map('trim', explode(';', $sql)));
    foreach ($queries as $q) {
        if ($q === '') continue;
        sql_query($q, false);
    }
    sql_query("INSERT INTO g5_schema_migrations (migration) VALUES ('" . sql_real_escape_string($name) . "')");
    echo "[OK] $name\n";
    $run[] = $name;
}

echo "\n완료. 실행된 마이그레이션: " . count($run) . "개\n";
```

> **참고**: 그누보드 설치 전에는 `common.php`가 없을 수 있음.  
> - **옵션 A**: 그누보드 설치 후 `run_migration.php` 사용 (common.php 로드)  
> - **옵션 B**: `migration_config.sample.php`에 DB 접속 정보만 두고, `run_migration.php`가 해당 설정으로 직접 MySQL 연결 (그누보드 없이 실행 가능)

#### 4.3.4 그누보드 설치 후 실행 순서

1. 그누보드5 설치 (bbs/install)
2. `000_schema_migrations.sql` 수동 실행 또는 `run_migration.php`에서 common.php 로드 후 실행
3. 이후 `php run_migration.php`로 마이그레이션 적용

### 4.4 산출물

- `migrations/` 디렉토리
- `000_schema_migrations.sql`
- `run_migration.php`

---

## 5. Phase 4: Cursor AI ↔ 서버 연결

### 5.1 목표

- Cursor 터미널에서 SSH로 서버 명령 실행
- 비밀번호 없이 키 기반 접속

### 5.2 사전 확인

- SSH 키 준비 완료 (사용자 확인됨)
- 키 경로 예: `C:\Users\DOGE\.ssh\evealba_key` 또는 `id_rsa`

### 5.3 단계별 액션

#### 5.3.1 SSH Config 등록 (선택, 편의용)

`C:\Users\DOGE\.ssh\config` 파일에 추가:

```
Host evealba
    HostName 188.166.179.115
    User root
    IdentityFile C:\Users\DOGE\.ssh\evealba_key
    ServerAliveInterval 60
```

이후 `ssh evealba`로 접속 가능.

#### 5.3.2 Cursor에서 원격 명령 실행

**Cursor AI에게 예시 지시:**

> "서버 evealba에 접속해서 /var/www/evealba 디렉토리 목록 확인해줘"

**Cursor가 실행할 명령 예시:**

```powershell
ssh -i C:\Users\DOGE\.ssh\evealba_key root@188.166.179.115 "ls -la /var/www/evealba"
```

또는 config 사용 시:

```powershell
ssh evealba "ls -la /var/www/evealba"
```

#### 5.3.3 배포용 단축 명령 (선택)

`d:\evealba\deploy.ps1` 또는 `deploy.sh` 생성 후, Cursor가 해당 스크립트를 실행하도록 요청.

### 5.4 검증

| 항목 | 명령 | 기대 결과 |
|------|------|-----------|
| SSH 접속 | `ssh evealba "hostname"` | evealba |
| 디렉토리 | `ssh evealba "ls /var/www/evealba"` | 목록 출력 |

### 5.5 산출물

- SSH config (선택)
- Cursor ↔ 서버 명령 실행 가능 상태

---

## 6. Phase 5: Cursor AI ↔ GitHub 연결

### 6.1 목표

- Cursor가 로컬에서 `git push` / `git pull` 실행
- GitHub 인증 설정

### 6.2 단계별 액션

#### 6.2.1 Git 인증 (HTTPS)

- **Personal Access Token** 사용 권장
- GitHub → Settings → Developer settings → Personal access tokens → Generate new token
- scope: `repo` 체크

`.git/config` 또는 Git Credential Manager로 저장:

```ini
[credential]
    helper = manager
```

또는 URL에 토큰 포함 (보안 주의):

```
https://토큰@github.com/본인아이디/evealba.git
```

#### 6.2.2 SSH 키로 GitHub 연결 (권장)

1. 로컬에 SSH 키 있음 확인: `ls ~/.ssh/id_*.pub` 또는 `evealba_key.pub`
2. GitHub → Settings → SSH and GPG keys → New SSH key
3. 공개키 내용 붙여넣기
4. 원격 URL을 SSH로 변경:

```powershell
git remote set-url origin git@github.com:본인아이디/evealba.git
```

#### 6.2.3 Cursor에서 Git 명령 실행

**Cursor AI에게 예시 지시:**

> "evealba 프로젝트를 GitHub에 푸시해줘"

**Cursor가 실행할 명령:**

```powershell
cd d:\evealba
git add .
git status
git commit -m "메시지"
git push origin main
```

### 6.3 검증

| 항목 | 명령 | 기대 결과 |
|------|------|-----------|
| 원격 확인 | `git remote -v` | origin URL 출력 |
| 푸시 | `git push origin main` | 성공 (인증 통과) |

### 6.4 산출물

- GitHub 인증 완료
- Cursor가 git push/pull 실행 가능

---

## 7. Phase 6: SQL Migration ↔ Cursor AI 연결

### 7.1 목표

- Cursor가 마이그레이션 파일 생성·수정
- Cursor가 `run_migration.php` 실행 (로컬 또는 서버)

### 7.2 연동 방식

| 역할 | 담당 | 방법 |
|------|------|------|
| 마이그레이션 파일 생성 | Cursor | 사용자 요청 시 `migrations/00X_xxx.sql` 생성 |
| 마이그레이션 실행 | Cursor | 터미널에서 `php run_migration.php` 또는 SSH로 서버에서 실행 |

### 7.3 단계별 액션

#### 7.3.1 Cursor Rules 설정 (선택)

`.cursorrules` 또는 프로젝트 규칙에 다음 내용 포함:

```
- SQL Migration 파일은 migrations/ 디렉토리에 00X_설명.sql 형식으로 생성
- 새 테이블/컬럼 추가 시 마이그레이션 파일 생성 후 run_migration.php 실행 제안
- 마이그레이션 실행 전 --dry-run 옵션으로 확인 권장
```

#### 7.3.2 마이그레이션 요청 예시

**사용자:** "ev_job 채용공고 테이블 추가해줘"

**Cursor 작업:**
1. `migrations/004_create_ev_job.sql` 생성
2. 사용자에게 `php run_migration.php` 또는 `php run_migration.php --dry-run` 실행 제안

#### 7.3.3 서버에서 마이그레이션 실행

```powershell
# 로컬에서 서버로 파일 전달 후 실행 (git pull 사용 시)
ssh evealba "cd /var/www/evealba && git pull && php run_migration.php"
```

### 7.4 검증

| 항목 | 방법 | 기대 결과 |
|------|------|-----------|
| 마이그레이션 파일 생성 | Cursor에 "ev_banner 테이블 마이그레이션 추가해줘" 요청 | `migrations/00X_xxx.sql` 생성 |
| 실행 | `php run_migration.php` | [OK] 메시지, DB에 테이블 생성 |
| 중복 방지 | 동일 마이그레이션 재실행 | [SKIP] 메시지 |

### 7.5 산출물

- Cursor ↔ SQL Migration 워크플로 정립
- 마이그레이션 생성·실행 절차 문서화

---

## 8. 동일 실수 방지용 해결책

| 상황 | 원인 | 해결책 |
|------|------|--------|
| SSH 접속 시 "Host key verification failed" | 서버 Rebuild 후 호스트 키 변경 | `ssh-keygen -R 188.166.179.115` 후 재접속 |
| git push 시 "Permission denied" | GitHub 인증 실패 | SSH 키 등록 또는 Personal Access Token 확인 |
| run_migration.php "common.php not found" | 그누보드 미설치 | 그누보드5 먼저 설치, 그 후 마이그레이션 실행 |
| 마이그레이션 중복 실행 | 실수로 같은 SQL 재실행 | schema_migrations로 이미 실행된 항목은 SKIP |
| .env/config.php가 GitHub에 푸시됨 | .gitignore 누락 | .gitignore에 추가 후 `git rm --cached .env` |
| 서버 php run_migration.php 권한 오류 | www-data가 실행 | `sudo -u www-data php run_migration.php` 또는 root 실행 |
| Nginx 502 Bad Gateway | PHP-FPM 미실행 | `systemctl status php8.3-fpm` 확인 후 시작 |
| DB 접속 실패 | common.php DB 설정 오류 | config.php 또는 .env의 DB 호스트/비밀번호 확인 |

---

## 9. 검증 체크리스트

### Phase 1 (서버)

- [ ] `php -v` → 8.2.x
- [ ] `mysql -u evealba -p evealba_db -e "SELECT 1"`
- [ ] `curl http://188.166.179.115` → 응답 (또는 404)

### Phase 2 (GitHub)

- [ ] `git remote -v` → origin URL 확인
- [ ] `git push origin main` 성공

### Phase 3 (SQL Migration)

- [ ] `migrations/` 디렉토리 존재
- [ ] `run_migration.php` 존재
- [ ] `000_schema_migrations.sql` 적용 후 `g5_schema_migrations` 테이블 생성 확인

### Phase 4 (Cursor ↔ 서버)

- [ ] `ssh evealba "hostname"` → evealba 출력
- [ ] Cursor가 SSH 명령 실행 가능

### Phase 5 (Cursor ↔ GitHub)

- [ ] Cursor가 `git push` 실행 가능
- [ ] GitHub에 커밋 반영 확인

### Phase 6 (SQL Migration ↔ Cursor)

- [ ] Cursor가 마이그레이션 파일 생성 가능
- [ ] `php run_migration.php` 또는 서버에서 실행 가능

---

## 10. 다음 단계 (플랜 완료 후)

1. 그누보드5 소스 배포 (`/var/www/evealba`)
2. 그누보드5 설치 (bbs/install)
3. ScorePoint 테마·플러그인(채팅) 이식
4. 이브알바 마스터 테이블 마이그레이션 작성 및 실행
5. Phase 1 기능 개발 시작 (액션플랜 문서 기준)

---

*플랜 끝*
